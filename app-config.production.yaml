# Production configuration for containerized deployment
# This file is merged with app-config.yaml

app:
  title: Cloud Sandbox
  baseUrl: http://localhost

organization:
  name: Platform Team

backend:
  baseUrl: http://localhost
  listen: ':7007'
  csp:
    connect-src: ["'self'", 'http:', 'https:']
  cors:
    # SECURITY: Restrict CORS to specific origins
    # Set CORS_ORIGIN environment variable to your frontend domain
    # Examples: "https://backstage.example.com" or "http://localhost:3000"
    origin: ${CORS_ORIGIN:-http://localhost}
    methods: [GET, HEAD, PATCH, POST, PUT, DELETE]
    credentials: true

  # PostgreSQL database
  database:
    client: pg
    connection:
      host: ${POSTGRES_HOST}
      port: ${POSTGRES_PORT}
      user: ${POSTGRES_USER}
      password: ${POSTGRES_PASSWORD}
      database: backstage

  # Redis cache
  cache:
    store: redis
    connection: redis://${REDIS_HOST}:${REDIS_PORT}

# GitHub integration
integrations:
  github:
    - host: github.com
      token: ${GITHUB_TOKEN}

# Kubernetes - provide empty clusters to satisfy required config
kubernetes:
  serviceLocatorMethod:
    type: 'multiTenant'
  clusterLocatorMethods:
    - type: config
      clusters: []

# TechDocs with MinIO (S3-compatible) storage
techdocs:
  builder: 'local'
  generator:
    runIn: 'local'
  publisher:
    type: 'awsS3'
    awsS3:
      bucketName: ${TECHDOCS_BUCKET}
      endpoint: http://${MINIO_HOST}:${MINIO_PORT}
      region: us-east-1
      s3ForcePathStyle: true
      credentials:
        accessKeyId: ${MINIO_ACCESS_KEY}
        secretAccessKey: ${MINIO_SECRET_KEY}

auth:
  environment: production
  providers:
    # SECURITY: Guest auth is DISABLED by default in production
    # To enable for demo purposes, set GUEST_AUTH_ENABLED=true in environment
    # WARNING: Enabling guest auth allows unauthenticated access
    guest:
      dangerouslyAllowOutsideDevelopment: ${GUEST_AUTH_ENABLED:-false}
    # GitHub OAuth for real GitHub users
    github:
      production:
        clientId: ${GITHUB_CLIENT_ID}
        clientSecret: ${GITHUB_CLIENT_SECRET}
        callbackUrl: http://localhost/api/auth/github/handler/frame

scaffolder:
  defaultAuthor:
    name: Cloud Sandbox
    email: platform-team@company.com
  defaultCommitMessage: 'Initial commit from Cloud Sandbox template'

# Proxy configuration for external API access
proxy:
  endpoints:
    '/github-api':
      target: https://api.github.com
      headers:
        Authorization: Bearer ${GITHUB_TOKEN}
        Accept: application/vnd.github.v3+json
      changeOrigin: true
      # Prevent incoming Authorization header from overriding our configured token
      allowedHeaders:
        - Content-Type

catalog:
  # Refresh entities automatically - check every 30 seconds for changes
  processingInterval: { seconds: 30 }
  rules:
    - allow:
        [
          Component,
          System,
          API,
          Resource,
          Location,
          Domain,
          Template,
          User,
          Group,
        ]

  # GitHub Organization Entity Provider - syncs teams and members
  providers:
    githubOrg:
      - id: production
        githubUrl: https://github.com
        orgs:
          - ${GITHUB_ORG}
        schedule:
          initialDelay: { seconds: 10 }
          frequency: { minutes: 5 }
          timeout: { minutes: 3 }

  locations:
    # Users and Groups
    - type: file
      target: ./catalog/users.yaml
      rules:
        - allow: [User, Group]

    # Domains
    - type: file
      target: ./catalog/domains.yaml
      rules:
        - allow: [Domain]
    - type: file
      target: ./catalog/devops-domains.yaml
      rules:
        - allow: [Domain]

    # Systems
    - type: file
      target: ./catalog/systems.yaml
      rules:
        - allow: [System]
    - type: file
      target: ./catalog/devops-systems.yaml
      rules:
        - allow: [System]

    # Components with TechDocs
    - type: file
      target: ./catalog/aws-services/catalog-info.yaml
    - type: file
      target: ./catalog/azure-services/catalog-info.yaml
    - type: file
      target: ./catalog/gcp-services/catalog-info.yaml
    - type: file
      target: ./catalog/multi-cloud-management/catalog-info.yaml
    - type: file
      target: ./catalog/ansible-webserver/catalog-info.yaml
    - type: file
      target: ./catalog/ansible-docker-host/catalog-info.yaml
    - type: file
      target: ./catalog/sample-nodejs-api/catalog-info.yaml
    - type: file
      target: ./catalog/sample-react-frontend/catalog-info.yaml
    - type: file
      target: ./catalog/cloudformation-templates/catalog-info.yaml
    - type: file
      target: ./catalog/pulumi-projects/catalog-info.yaml
    - type: file
      target: ./catalog/helm-charts/catalog-info.yaml
    - type: file
      target: ./catalog/docker-images/catalog-info.yaml
    - type: file
      target: ./catalog/packer/catalog-info.yaml
    - type: file
      target: ./catalog/terraform-modules/catalog-info.yaml
    - type: file
      target: ./catalog/prometheus-stack/catalog-info.yaml
    - type: file
      target: ./catalog/elk-stack/catalog-info.yaml
    - type: file
      target: ./catalog/jaeger-tracing/catalog-info.yaml
    - type: file
      target: ./catalog/datadog-integration/catalog-info.yaml
    - type: file
      target: ./catalog/new-relic-integration/catalog-info.yaml
    - type: file
      target: ./catalog/splunk-enterprise/catalog-info.yaml
    - type: file
      target: ./catalog/pagerduty-integration/catalog-info.yaml
    - type: file
      target: ./catalog/testing-frameworks/catalog-info.yaml
    - type: file
      target: ./catalog/sonarqube/catalog-info.yaml
    - type: file
      target: ./catalog/security-scanning-suite/catalog-info.yaml
    - type: file
      target: ./catalog/performance-testing/catalog-info.yaml
    - type: file
      target: ./catalog/ci-cd-pipelines/catalog-info.yaml
    - type: file
      target: ./catalog/artifact-repository/catalog-info.yaml
    - type: file
      target: ./catalog/postgresql-cluster/catalog-info.yaml
    - type: file
      target: ./catalog/mongodb-cluster/catalog-info.yaml
    - type: file
      target: ./catalog/redis-cluster/catalog-info.yaml
    - type: file
      target: ./catalog/elasticsearch-data/catalog-info.yaml
    - type: file
      target: ./catalog/apache-kafka/catalog-info.yaml
    - type: file
      target: ./catalog/rabbitmq-cluster/catalog-info.yaml
    - type: file
      target: ./catalog/apache-spark/catalog-info.yaml
    - type: file
      target: ./catalog/apache-airflow/catalog-info.yaml
    - type: file
      target: ./catalog/zookeeper-ensemble/catalog-info.yaml
    - type: file
      target: ./catalog/minio-storage/catalog-info.yaml
    - type: file
      target: ./catalog/awx-core/catalog-info.yaml
    - type: file
      target: ./catalog/awx-operator/catalog-info.yaml
    - type: file
      target: ./catalog/awx-helm-chart/catalog-info.yaml

    # APIs and Resources
    - type: file
      target: ./catalog/apis-and-resources.yaml
      rules:
        - allow: [API, Resource]

    # Templates
    - type: file
      target: ./templates/terraform-module/template.yaml
      rules:
        - allow: [Template]
    - type: file
      target: ./templates/terraform-infrastructure/template.yaml
      rules:
        - allow: [Template]
    - type: file
      target: ./templates/ansible-playbook/template.yaml
      rules:
        - allow: [Template]
    - type: file
      target: ./templates/kubernetes-microservice/template.yaml
      rules:
        - allow: [Template]
    - type: file
      target: ./templates/docker-application/template.yaml
      rules:
        - allow: [Template]
    - type: file
      target: ./templates/awx-deployment/template.yaml
      rules:
        - allow: [Template]
    - type: file
      target: ./templates/packer-image/template.yaml
      rules:
        - allow: [Template]
    - type: file
      target: ./templates/vagrant-environment/template.yaml
      rules:
        - allow: [Template]
    - type: file
      target: ./templates/cloud-sandbox/template.yaml
      rules:
        - allow: [Template]

    # GitHub Organization Management Templates
    - type: file
      target: ./templates/github-team/template.yaml
      rules:
        - allow: [Template]
    - type: file
      target: ./templates/github-user/template.yaml
      rules:
        - allow: [Template]
    - type: file
      target: ./templates/github-team-member/template.yaml
      rules:
        - allow: [Template]

    # AWS Cloud Templates
    - type: file
      target: ./templates/aws-vpc/template.yaml
      rules:
        - allow: [Template]
    - type: file
      target: ./templates/aws-lambda/template.yaml
      rules:
        - allow: [Template]
    - type: file
      target: ./templates/aws-s3/template.yaml
      rules:
        - allow: [Template]
    - type: file
      target: ./templates/aws-rds/template.yaml
      rules:
        - allow: [Template]
    - type: file
      target: ./templates/aws-eks/template.yaml
      rules:
        - allow: [Template]
    - type: file
      target: ./templates/aws-cloudfront/template.yaml
      rules:
        - allow: [Template]

    # Azure Cloud Templates
    - type: file
      target: ./templates/azure-vnet/template.yaml
      rules:
        - allow: [Template]
    - type: file
      target: ./templates/azure-aks/template.yaml
      rules:
        - allow: [Template]
    - type: file
      target: ./templates/azure-static-web/template.yaml
      rules:
        - allow: [Template]
    - type: file
      target: ./templates/azure-functions/template.yaml
      rules:
        - allow: [Template]

    # GCP Cloud Templates
    - type: file
      target: ./templates/gcp-vpc/template.yaml
      rules:
        - allow: [Template]
    - type: file
      target: ./templates/gcp-gke/template.yaml
      rules:
        - allow: [Template]
    - type: file
      target: ./templates/gcp-cloud-run/template.yaml
      rules:
        - allow: [Template]
    - type: file
      target: ./templates/gcp-cloud-sql/template.yaml
      rules:
        - allow: [Template]

    # Data Engineering Templates
    - type: file
      target: ./templates/data-airflow/template.yaml
      rules:
        - allow: [Template]
    - type: file
      target: ./templates/data-dbt/template.yaml
      rules:
        - allow: [Template]
    - type: file
      target: ./templates/data-superset/template.yaml
      rules:
        - allow: [Template]

    # Application Templates
    - type: file
      target: ./templates/app-nodejs-api/template.yaml
      rules:
        - allow: [Template]
    - type: file
      target: ./templates/app-nextjs/template.yaml
      rules:
        - allow: [Template]
    - type: file
      target: ./templates/app-springboot/template.yaml
      rules:
        - allow: [Template]
    - type: file
      target: ./templates/python-api/template.yaml
      rules:
        - allow: [Template]
    - type: file
      target: ./templates/react-frontend/template.yaml
      rules:
        - allow: [Template]

    # SRE/Observability Templates
    - type: file
      target: ./templates/sre-monitoring/template.yaml
      rules:
        - allow: [Template]

    # Automation Templates
    - type: file
      target: ./templates/ansible-docker/template.yaml
      rules:
        - allow: [Template]
    - type: file
      target: ./templates/ansible-nginx/template.yaml
      rules:
        - allow: [Template]

    # Marketing Templates
    - type: file
      target: ./templates/marketing-static-site/template.yaml
      rules:
        - allow: [Template]
    - type: file
      target: ./templates/marketing-landing-page/template.yaml
      rules:
        - allow: [Template]

    # Testing Templates
    - type: file
      target: ./templates/test-playwright/template.yaml
      rules:
        - allow: [Template]
    - type: file
      target: ./templates/test-k6-load/template.yaml
      rules:
        - allow: [Template]

    # Documentation Templates
    - type: file
      target: ./templates/docs-project/template.yaml
      rules:
        - allow: [Template]
    - type: file
      target: ./templates/docs-adr/template.yaml
      rules:
        - allow: [Template]
    - type: file
      target: ./templates/docs-runbook/template.yaml
      rules:
        - allow: [Template]
    - type: file
      target: ./templates/docs-d2-guide/template.yaml
      rules:
        - allow: [Template]

permission:
  # SECURITY: Permission system is enabled in production
  # See packages/backend/src/permissionPolicy.ts for the policy implementation
  enabled: true
