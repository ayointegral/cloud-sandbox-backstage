# Development Dockerfile with hot reload
FROM node:22-bookworm-slim

ENV PYTHON=/usr/bin/python3

RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        python3 \
        python3-pip \
        python3-venv \
        g++ \
        build-essential \
        libsqlite3-dev \
        git \
        curl \
        ca-certificates && \
    rm -rf /var/lib/apt/lists/*

# Install D2 diagramming tool (multi-arch support)
RUN ARCH=$(dpkg --print-architecture) && \
    if [ "$ARCH" = "arm64" ]; then D2_ARCH="linux-arm64"; else D2_ARCH="linux-amd64"; fi && \
    D2_VERSION="v0.7.1" && \
    curl -fsSL "https://github.com/terrastruct/d2/releases/download/${D2_VERSION}/d2-${D2_VERSION}-${D2_ARCH}.tar.gz" -o /tmp/d2.tar.gz && \
    mkdir -p /tmp/d2 && \
    tar -xzf /tmp/d2.tar.gz -C /tmp/d2 --strip-components=1 && \
    cp /tmp/d2/bin/d2 /usr/local/bin/d2 && \
    chmod +x /usr/local/bin/d2 && \
    rm -rf /tmp/d2 /tmp/d2.tar.gz && \
    d2 --version

# Install mkdocs and plugins for TechDocs (including D2 support)
RUN pip3 install --no-cache-dir --break-system-packages \
    mkdocs \
    mkdocs-material \
    mkdocs-monorepo-plugin \
    mkdocs-awesome-pages-plugin \
    mkdocs-techdocs-core \
    mkdocs-d2-plugin \
    markdown-inline-mermaid \
    plantuml-markdown \
    pygments

# Install MinIO client for TechDocs upload (multi-arch support)
RUN ARCH=$(dpkg --print-architecture) && \
    if [ "$ARCH" = "arm64" ]; then MC_ARCH="linux-arm64"; else MC_ARCH="linux-amd64"; fi && \
    curl -fsSL "https://dl.min.io/client/mc/release/${MC_ARCH}/mc" -o /usr/local/bin/mc && \
    chmod +x /usr/local/bin/mc

WORKDIR /app

# Copy package files
COPY package.json yarn.lock .yarnrc.yml ./
COPY .yarn ./.yarn
COPY backstage.json ./
COPY packages/app/package.json ./packages/app/
COPY packages/backend/package.json ./packages/backend/

# Install dependencies
RUN yarn install

# Copy source code
COPY . .

# Expose ports
EXPOSE 3000 7007 9229

# Start in development mode
CMD ["yarn", "start"]
