# Development Dockerfile with hot reload
FROM node:22-bookworm-slim

ENV PYTHON=/usr/bin/python3

RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        python3 \
        python3-pip \
        python3-venv \
        g++ \
        build-essential \
        libsqlite3-dev \
        git \
        curl && \
    rm -rf /var/lib/apt/lists/*

# Install mkdocs and plugins for TechDocs
RUN pip3 install --no-cache-dir --break-system-packages \
    mkdocs \
    mkdocs-material \
    mkdocs-monorepo-plugin \
    mkdocs-awesome-pages-plugin \
    mkdocs-techdocs-core \
    markdown-inline-mermaid \
    plantuml-markdown \
    pygments

WORKDIR /app

# Copy package files
COPY package.json yarn.lock .yarnrc.yml ./
COPY .yarn ./.yarn
COPY backstage.json ./
COPY packages/app/package.json ./packages/app/
COPY packages/backend/package.json ./packages/backend/

# Install dependencies
RUN yarn install

# Copy source code
COPY . .

# Expose ports
EXPOSE 3000 7007 9229

# Start in development mode
CMD ["yarn", "start"]
