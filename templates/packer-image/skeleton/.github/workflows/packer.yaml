name: Packer Image CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      image_name:
        description: 'Image template to build'
        required: true
        default: 'base'
      cloud_provider:
        description: 'Cloud provider target'
        required: true
        default: 'aws'
        type: choice
        options:
          - aws
          - azure
          - gcp
          - all

permissions:
  contents: read
  security-events: write
  id-token: write

env:
  PACKER_VERSION: '1.11.2'

jobs:
  # ============================================
  # LINT & VALIDATE
  # ============================================
  validate:
    name: Validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Packer
        uses: hashicorp/setup-packer@main
        with:
          version: ${{ env.PACKER_VERSION }}

      - name: Packer Format Check
        run: |
          packer fmt -check -recursive .

      - name: Initialize Packer
        run: |
          for template in $(find . -name "*.pkr.hcl" -type f); do
            dir=$(dirname "$template")
            echo "Initializing: $dir"
            packer init "$dir"
          done

      - name: Validate Packer Templates
        run: |
          for template in $(find . -name "*.pkr.hcl" -type f | grep -v variables); do
            echo "Validating: $template"
            packer validate -syntax-only "$template"
          done

      - name: Run HCL lint
        uses: terraform-linters/setup-tflint@v4
        continue-on-error: true

  # ============================================
  # SECURITY SCANNING
  # ============================================
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Trivy IaC Scanner
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: 'config'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'

      - name: Upload Trivy SARIF
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: trivy-results.sarif
          category: trivy

      - name: Check for hardcoded secrets
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
        continue-on-error: true

      - name: Check provisioner scripts
        run: |
          # Check shell scripts for security issues
          if command -v shellcheck &> /dev/null; then
            find . -name "*.sh" -exec shellcheck {} \; || true
          fi

  # ============================================
  # BUILD - AWS AMI
  # ============================================
  build-aws:
    name: Build AWS AMI
    runs-on: ubuntu-latest
    needs: [validate, security]
    if: |
      github.ref == 'refs/heads/main' ||
      (github.event_name == 'workflow_dispatch' && 
       (github.event.inputs.cloud_provider == 'aws' || github.event.inputs.cloud_provider == 'all'))
    environment: aws
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Packer
        uses: hashicorp/setup-packer@main
        with:
          version: ${{ env.PACKER_VERSION }}

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION || 'us-west-2' }}

      - name: Initialize Packer
        run: packer init aws/

      - name: Build AMI
        run: |
          packer build \
            -var "version=${{ github.sha }}" \
            -var "build_number=${{ github.run_number }}" \
            -color=false \
            aws/
        env:
          PACKER_LOG: 1
          PACKER_LOG_PATH: packer-aws.log

      - name: Upload build log
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: packer-aws-log
          path: packer-aws.log

      - name: Output AMI ID
        id: ami
        run: |
          AMI_ID=$(grep -oP 'ami-[a-z0-9]+' packer-aws.log | tail -1)
          echo "ami_id=$AMI_ID" >> $GITHUB_OUTPUT
          echo "Built AMI: $AMI_ID"

  # ============================================
  # BUILD - Azure Image
  # ============================================
  build-azure:
    name: Build Azure Image
    runs-on: ubuntu-latest
    needs: [validate, security]
    if: |
      github.ref == 'refs/heads/main' ||
      (github.event_name == 'workflow_dispatch' && 
       (github.event.inputs.cloud_provider == 'azure' || github.event.inputs.cloud_provider == 'all'))
    environment: azure
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Packer
        uses: hashicorp/setup-packer@main
        with:
          version: ${{ env.PACKER_VERSION }}

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Initialize Packer
        run: packer init azure/

      - name: Build Azure Image
        run: |
          packer build \
            -var "version=${{ github.sha }}" \
            -var "build_number=${{ github.run_number }}" \
            -color=false \
            azure/
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          PACKER_LOG: 1
          PACKER_LOG_PATH: packer-azure.log

      - name: Upload build log
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: packer-azure-log
          path: packer-azure.log

  # ============================================
  # BUILD - GCP Image
  # ============================================
  build-gcp:
    name: Build GCP Image
    runs-on: ubuntu-latest
    needs: [validate, security]
    if: |
      github.ref == 'refs/heads/main' ||
      (github.event_name == 'workflow_dispatch' && 
       (github.event.inputs.cloud_provider == 'gcp' || github.event.inputs.cloud_provider == 'all'))
    environment: gcp
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Packer
        uses: hashicorp/setup-packer@main
        with:
          version: ${{ env.PACKER_VERSION }}

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_CREDENTIALS }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Initialize Packer
        run: packer init gcp/

      - name: Build GCP Image
        run: |
          packer build \
            -var "project_id=${{ secrets.GCP_PROJECT_ID }}" \
            -var "version=${{ github.sha }}" \
            -var "build_number=${{ github.run_number }}" \
            -color=false \
            gcp/
        env:
          PACKER_LOG: 1
          PACKER_LOG_PATH: packer-gcp.log

      - name: Upload build log
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: packer-gcp-log
          path: packer-gcp.log

  # ============================================
  # SCAN BUILT IMAGES
  # ============================================
  scan-images:
    name: Scan Built Images
    runs-on: ubuntu-latest
    needs: [build-aws, build-azure, build-gcp]
    if: always() && (needs.build-aws.result == 'success' || needs.build-azure.result == 'success' || needs.build-gcp.result == 'success')
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        if: needs.build-aws.result == 'success'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION || 'us-west-2' }}

      - name: Scan AMI with Inspector
        if: needs.build-aws.result == 'success'
        run: |
          # Trigger AWS Inspector scan on the new AMI
          echo "Triggering Inspector scan..."
          # aws inspector2 create-findings-report ...
        continue-on-error: true

      - name: Document image metadata
        run: |
          echo "## Built Images" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Provider | Status | Image ID |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| AWS | ${{ needs.build-aws.result }} | ${{ needs.build-aws.outputs.ami_id || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Azure | ${{ needs.build-azure.result }} | - |" >> $GITHUB_STEP_SUMMARY
          echo "| GCP | ${{ needs.build-gcp.result }} | - |" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # CLEANUP OLD IMAGES
  # ============================================
  cleanup:
    name: Cleanup Old Images
    runs-on: ubuntu-latest
    needs: [build-aws, build-azure, build-gcp]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION || 'us-west-2' }}

      - name: Cleanup old AMIs
        run: |
          # Keep only the 5 most recent AMIs
          echo "Cleaning up old AMIs..."
          # aws ec2 describe-images --owners self --query 'Images | sort_by(@, &CreationDate) | [:-5].[ImageId]' --output text | \
          # xargs -I {} aws ec2 deregister-image --image-id {}
        continue-on-error: true

  # ============================================
  # NOTIFY
  # ============================================
  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: [build-aws, build-azure, build-gcp]
    if: always() && github.ref == 'refs/heads/main'
    steps:
      - name: Create summary
        uses: actions/github-script@v7
        with:
          script: |
            const results = {
              aws: '${{ needs.build-aws.result }}',
              azure: '${{ needs.build-azure.result }}',
              gcp: '${{ needs.build-gcp.result }}'
            };

            let summary = '## Packer Build Summary\\n\\n';
            for (const [provider, result] of Object.entries(results)) {
              const emoji = result === 'success' ? '✅' : result === 'failure' ? '❌' : '⏭️';
              summary += `- ${provider.toUpperCase()}: ${emoji} ${result}\\n`;
            }

            console.log(summary);
