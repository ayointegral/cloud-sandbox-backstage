{% if values.enable_hpa %}
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: ${{ values.name }}-hpa
  namespace: ${{ values.kubernetes_namespace }}
  labels:
    app: ${{ values.name }}
  annotations:
    backstage.io/kubernetes-id: ${{ values.name }}
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: ${{ values.name }}
  minReplicas: 3
  maxReplicas: 10
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
      - type: Percent
        value: 50
        periodSeconds: 60
    scaleUp:
      stabilizationWindowSeconds: 60
      policies:
      - type: Percent
        value: 100
        periodSeconds: 30
      - type: Pods
        value: 2
        periodSeconds: 60
      selectPolicy: Max

---
{% endif %}
{% if values.enable_pdb %}
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: ${{ values.name }}-pdb
  namespace: ${{ values.kubernetes_namespace }}
  labels:
    app: ${{ values.name }}
  annotations:
    backstage.io/kubernetes-id: ${{ values.name }}
spec:
  minAvailable: 2
  selector:
    matchLabels:
      app: ${{ values.name }}

---
{% endif %}
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: ${{ values.name }}-ingress
  namespace: ${{ values.kubernetes_namespace }}
  labels:
    app: ${{ values.name }}
  annotations:
    backstage.io/kubernetes-id: ${{ values.name }}
    kubernetes.io/ingress.class: "nginx"
    nginx.ingress.kubernetes.io/rewrite-target: /
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    nginx.ingress.kubernetes.io/rate-limit: "100"
    nginx.ingress.kubernetes.io/rate-limit-window: "1m"
    {% if values.enable_security_scanning %}
    nginx.ingress.kubernetes.io/enable-modsecurity: "true"
    nginx.ingress.kubernetes.io/modsecurity-snippet: |
      SecRule REQUEST_HEADERS:User-Agent "@detectSQLi" \
        "id:1001,\
        phase:1,\
        block,\
        msg:'SQL Injection Attack Detected',\
        logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}',\
        severity:2"
    {% endif %}
spec:
  tls:
  - hosts:
    - ${{ values.name }}.company.com
    secretName: ${{ values.name }}-tls
  rules:
  - host: ${{ values.name }}.company.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: ${{ values.name }}
            port:
              number: 80

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: ${{ values.name }}-netpol
  namespace: ${{ values.kubernetes_namespace }}
  labels:
    app: ${{ values.name }}
  annotations:
    backstage.io/kubernetes-id: ${{ values.name }}
spec:
  podSelector:
    matchLabels:
      app: ${{ values.name }}
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          name: ingress-nginx
    - podSelector:
        matchLabels:
          app: nginx-ingress
    ports:
    - protocol: TCP
      port: {% if values.language === 'nodejs' %}3000{% elif values.language === 'python' %}8000{% elif values.language === 'java' %}8080{% elif values.language === 'golang' %}8080{% elif values.language === 'dotnet' %}5000{% endif %}
  {% if values.monitoring_stack === 'prometheus-grafana' %}
  - from:
    - namespaceSelector:
        matchLabels:
          name: monitoring
    ports:
    - protocol: TCP
      port: 9090
  {% endif %}
  egress:
  # Allow DNS resolution
  - to: []
    ports:
    - protocol: UDP
      port: 53
  # Allow HTTPS outbound
  - to: []
    ports:
    - protocol: TCP
      port: 443
  {% if values.database_type !== 'none' %}
  # Allow database access
  - to:
    - podSelector:
        matchLabels:
          app: ${{ values.name }}-database
    ports:
    - protocol: TCP
      port: {% if values.database_type === 'postgresql' %}5432{% elif values.database_type === 'mysql' %}3306{% elif values.database_type === 'mongodb' %}27017{% elif values.database_type === 'redis' %}6379{% endif %}
  {% endif %}
  {% if values.message_queue !== 'none' %}
  # Allow message queue access
  - to:
    - podSelector:
        matchLabels:
          app: ${{ values.name }}-messagequeue
    ports:
    - protocol: TCP
      port: {% if values.message_queue === 'rabbitmq' %}5672{% elif values.message_queue === 'kafka' %}9092{% elif values.message_queue === 'redis-pub-sub' %}6379{% endif %}
  {% endif %}
