name: Monitoring CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  security-events: write

env:
  PROMETHEUS_VERSION: '2.48.0'

jobs:
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Trivy config scanner
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: 'config'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'

      - name: Upload Trivy SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: trivy-results.sarif
          category: trivy

  validate:
    name: Validate Configuration
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download promtool
        run: |
          wget -q https://github.com/prometheus/prometheus/releases/download/v${{ env.PROMETHEUS_VERSION }}/prometheus-${{ env.PROMETHEUS_VERSION }}.linux-amd64.tar.gz
          tar xzf prometheus-${{ env.PROMETHEUS_VERSION }}.linux-amd64.tar.gz
          sudo mv prometheus-${{ env.PROMETHEUS_VERSION }}.linux-amd64/promtool /usr/local/bin/

      - name: Validate Prometheus rules
        run: |
          for file in alerts/*.yaml alerts/*.yml; do
            if [ -f "$file" ]; then
              echo "Validating: $file"
              promtool check rules "$file"
            fi
          done

      - name: Validate Prometheus config
        run: |
          if [ -f "prometheus.yml" ]; then
            promtool check config prometheus.yml
          fi

      - name: Validate Alertmanager config
        run: |
          wget -q https://github.com/prometheus/alertmanager/releases/download/v0.26.0/alertmanager-0.26.0.linux-amd64.tar.gz
          tar xzf alertmanager-0.26.0.linux-amd64.tar.gz
          if [ -f "alertmanager.yml" ]; then
            ./alertmanager-0.26.0.linux-amd64/amtool check-config alertmanager.yml
          fi

  lint-dashboards:
    name: Lint Grafana Dashboards
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Validate JSON syntax
        run: |
          for file in dashboards/*.json; do
            if [ -f "$file" ]; then
              echo "Validating JSON: $file"
              python3 -m json.tool "$file" > /dev/null
            fi
          done

      - name: Check dashboard structure
        run: |
          for file in dashboards/*.json; do
            if [ -f "$file" ]; then
              echo "Checking dashboard structure: $file"
              # Check for required fields
              jq -e '.title' "$file" > /dev/null || (echo "Missing title in $file" && exit 1)
              jq -e '.panels' "$file" > /dev/null || (echo "Missing panels in $file" && exit 1)
            fi
          done

  test-stack:
    name: Test Monitoring Stack
    runs-on: ubuntu-latest
    needs: [validate, lint-dashboards]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Start monitoring stack
        run: |
          docker-compose up -d
          sleep 30

      - name: Check Prometheus health
        run: |
          curl -sf http://localhost:9090/-/healthy || exit 1
          echo "Prometheus is healthy"

      - name: Check Alertmanager health
        run: |
          curl -sf http://localhost:9093/-/healthy || exit 1
          echo "Alertmanager is healthy"

      - name: Check Grafana health
        run: |
          curl -sf http://localhost:3000/api/health || exit 1
          echo "Grafana is healthy"

      - name: Verify rules loaded
        run: |
          rules=$(curl -s http://localhost:9090/api/v1/rules | jq '.data.groups | length')
          if [ "$rules" -eq 0 ]; then
            echo "Warning: No alert rules loaded"
          else
            echo "Loaded $rules rule groups"
          fi

      - name: Cleanup
        if: always()
        run: docker-compose down -v

  deploy:
    name: Deploy Monitoring
    runs-on: ubuntu-latest
    needs: [test-stack]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure kubectl
        run: |
          echo "Configure kubectl for your cluster"
          # Example:
          # echo "${{ secrets.KUBECONFIG }}" | base64 -d > kubeconfig
          # export KUBECONFIG=kubeconfig

      - name: Apply Prometheus rules
        run: |
          echo "Applying Prometheus rules to cluster..."
          # Example for Prometheus Operator:
          # kubectl apply -f alerts/

      - name: Import Grafana dashboards
        env:
          GRAFANA_API_KEY: ${{ secrets.GRAFANA_API_KEY }}
          GRAFANA_URL: ${{ secrets.GRAFANA_URL }}
        run: |
          if [ -n "$GRAFANA_API_KEY" ] && [ -n "$GRAFANA_URL" ]; then
            chmod +x scripts/import-dashboards.sh
            ./scripts/import-dashboards.sh
          else
            echo "Skipping dashboard import - credentials not configured"
          fi
