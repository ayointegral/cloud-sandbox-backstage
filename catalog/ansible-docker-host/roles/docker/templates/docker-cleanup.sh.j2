#!/bin/bash
# Docker cleanup script
# Generated by Ansible

set -euo pipefail

TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
echo "[$TIMESTAMP] Starting Docker cleanup..."

{% if docker_cleanup_prune_images | bool %}
echo "[$TIMESTAMP] Pruning unused images older than {{ docker_cleanup_image_age }}..."
docker image prune -af --filter "until={{ docker_cleanup_image_age }}" || true
{% endif %}

{% if docker_cleanup_prune_volumes | bool %}
echo "[$TIMESTAMP] Pruning unused volumes..."
docker volume prune -f || true
{% endif %}

{% if docker_cleanup_prune_networks | bool %}
echo "[$TIMESTAMP] Pruning unused networks..."
docker network prune -f || true
{% endif %}

{% if docker_cleanup_prune_buildcache | bool %}
echo "[$TIMESTAMP] Pruning build cache..."
docker builder prune -af --keep-storage 5GB || true
{% endif %}

# Remove stopped containers older than 24h
echo "[$TIMESTAMP] Removing stopped containers..."
docker container prune -f --filter "until=24h" || true

# Display disk usage after cleanup
echo "[$TIMESTAMP] Docker disk usage after cleanup:"
docker system df

TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
echo "[$TIMESTAMP] Docker cleanup completed."
