name: Helm Charts CI

on:
  push:
    branches: [main, master]
    paths:
      - 'charts/**'
      - '.github/workflows/helm.yaml'
  pull_request:
    branches: [main, master]
    paths:
      - 'charts/**'
      - '.github/workflows/helm.yaml'

permissions:
  contents: read
  packages: write

env:
  HELM_VERSION: v3.14.0

jobs:
  lint:
    name: Lint Charts
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: ${{ env.HELM_VERSION }}

      - name: Set up chart-testing
        uses: helm/chart-testing-action@v2

      - name: Run chart-testing (lint)
        run: ct lint --target-branch ${{ github.event.repository.default_branch }} --charts charts/*

  template:
    name: Template Charts
    runs-on: ubuntu-latest
    needs: lint
    strategy:
      matrix:
        chart:
          - webapp
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: ${{ env.HELM_VERSION }}

      - name: Template chart
        run: |
          helm dependency update charts/${{ matrix.chart }}
          helm template test charts/${{ matrix.chart }} --debug

      - name: Template with values variations
        run: |
          # Test with autoscaling enabled
          helm template test charts/${{ matrix.chart }} \
            --set autoscaling.enabled=true \
            --set autoscaling.minReplicas=2 \
            --set autoscaling.maxReplicas=10

          # Test with ingress enabled
          helm template test charts/${{ matrix.chart }} \
            --set ingress.enabled=true \
            --set ingress.className=nginx \
            --set 'ingress.hosts[0].host=example.com' \
            --set 'ingress.hosts[0].paths[0].path=/' \
            --set 'ingress.hosts[0].paths[0].pathType=Prefix'

          # Test with metrics enabled
          helm template test charts/${{ matrix.chart }} \
            --set metrics.enabled=true \
            --set metrics.serviceMonitor.enabled=true

          # Test with networkPolicy enabled
          helm template test charts/${{ matrix.chart }} \
            --set networkPolicy.enabled=true

  validate:
    name: Validate Charts
    runs-on: ubuntu-latest
    needs: template
    strategy:
      matrix:
        chart:
          - webapp
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: ${{ env.HELM_VERSION }}

      - name: Install kubeconform
        run: |
          curl -sSL https://github.com/yannh/kubeconform/releases/download/v0.6.4/kubeconform-linux-amd64.tar.gz | tar xz
          sudo mv kubeconform /usr/local/bin/

      - name: Validate templates
        run: |
          helm dependency update charts/${{ matrix.chart }}
          helm template test charts/${{ matrix.chart }} | kubeconform -strict -summary

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: lint
    strategy:
      matrix:
        chart:
          - webapp
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: ${{ env.HELM_VERSION }}

      - name: Install trivy
        run: |
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin

      - name: Scan chart for misconfigurations
        run: |
          helm dependency update charts/${{ matrix.chart }}
          helm template test charts/${{ matrix.chart }} > /tmp/manifests.yaml
          trivy config /tmp/manifests.yaml --severity HIGH,CRITICAL --exit-code 0

  docs:
    name: Generate Documentation
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install helm-docs
        run: |
          curl -sSL https://github.com/norwoodj/helm-docs/releases/download/v1.13.0/helm-docs_1.13.0_Linux_x86_64.tar.gz | tar xz
          sudo mv helm-docs /usr/local/bin/

      - name: Generate docs
        run: helm-docs --chart-search-root charts

      - name: Check for changes
        run: |
          if git diff --exit-code; then
            echo "Documentation is up to date"
          else
            echo "Documentation needs to be regenerated. Run: helm-docs --chart-search-root charts"
            exit 1
          fi

  package:
    name: Package Charts
    runs-on: ubuntu-latest
    needs: [validate, security-scan]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: ${{ env.HELM_VERSION }}

      - name: Package charts
        run: |
          mkdir -p .packages
          for chart in charts/*; do
            if [ -d "$chart" ]; then
              helm dependency update "$chart"
              helm package "$chart" -d .packages
            fi
          done

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: helm-packages
          path: .packages/*.tgz
          retention-days: 7
