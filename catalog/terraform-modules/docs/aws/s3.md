# AWS S3 Module

Creates a secure S3 bucket with encryption, versioning, lifecycle policies, and SSL enforcement following AWS security best practices.

## Features

- Server-side encryption (AES256 or KMS)
- Versioning with lifecycle management
- Public access blocking
- SSL/TLS enforcement
- Access logging
- CORS configuration
- Cross-region replication support
- Object lock support

## Usage

### Basic Usage

```hcl
module "s3" {
  source = "../../../aws/resources/storage/s3"

  name        = "myapp-data"
  environment = "prod"
}
```

### Production Configuration

```hcl
module "s3" {
  source = "../../../aws/resources/storage/s3"

  name        = "myapp-data"
  environment = "prod"

  versioning_enabled  = true
  block_public_access = true

  # KMS encryption
  encryption_type = "aws:kms"
  kms_key_arn     = aws_kms_key.s3.arn

  # Access logging
  enable_logging = true
  logging_bucket = module.logging_bucket.bucket_id

  # Lifecycle rules
  lifecycle_rules = [
    {
      id              = "archive-old-versions"
      enabled         = true
      expiration_days = 365
      noncurrent_version_expiration_days = 90
      transition = [
        {
          days          = 30
          storage_class = "STANDARD_IA"
        },
        {
          days          = 90
          storage_class = "GLACIER"
        }
      ]
    }
  ]

  tags = {
    DataClassification = "confidential"
  }
}
```

### Static Website Hosting

```hcl
module "s3_website" {
  source = "../../../aws/resources/storage/s3"

  name        = "myapp-website"
  environment = "prod"

  block_public_access = false  # Required for website hosting
  versioning_enabled  = true

  cors_rules = [{
    allowed_headers = ["*"]
    allowed_methods = ["GET", "HEAD"]
    allowed_origins = ["https://example.com"]
    expose_headers  = ["ETag"]
    max_age_seconds = 3600
  }]
}
```

### Application Bucket with Replication

```hcl
module "s3_primary" {
  source = "../../../aws/resources/storage/s3"

  name        = "myapp-data"
  environment = "prod"

  versioning_enabled = true  # Required for replication

  enable_replication                  = true
  replication_destination_bucket_arn  = "arn:aws:s3:::myapp-data-replica"
  replication_destination_kms_key_arn = "arn:aws:kms:eu-west-1:123456789012:key/xxx"
}
```

## Variables

| Name                                 | Description                       | Type           | Default    | Required |
| ------------------------------------ | --------------------------------- | -------------- | ---------- | -------- |
| `name`                               | Bucket name prefix                | `string`       | -          | Yes      |
| `environment`                        | Environment (dev, staging, prod)  | `string`       | -          | Yes      |
| `force_destroy`                      | Allow deletion with objects       | `bool`         | `false`    | No       |
| `versioning_enabled`                 | Enable versioning                 | `bool`         | `true`     | No       |
| `encryption_type`                    | Encryption type (AES256, aws:kms) | `string`       | `"AES256"` | No       |
| `kms_key_arn`                        | KMS key ARN for encryption        | `string`       | `null`     | No       |
| `block_public_access`                | Block all public access           | `bool`         | `true`     | No       |
| `enable_logging`                     | Enable access logging             | `bool`         | `true`     | No       |
| `logging_bucket`                     | Target bucket for logs            | `string`       | `null`     | No       |
| `lifecycle_rules`                    | Lifecycle rules                   | `list(object)` | `[]`       | No       |
| `cors_rules`                         | CORS rules                        | `list(object)` | `[]`       | No       |
| `enable_replication`                 | Enable cross-region replication   | `bool`         | `false`    | No       |
| `replication_destination_bucket_arn` | Destination bucket ARN            | `string`       | `null`     | No       |
| `object_lock_enabled`                | Enable object lock                | `bool`         | `false`    | No       |
| `tags`                               | Tags to apply to resources        | `map(string)`  | `{}`       | No       |

### Lifecycle Rule Configuration

```hcl
lifecycle_rules = [{
  id                                 = "rule-name"
  enabled                            = true
  prefix                             = "logs/"
  expiration_days                    = 365
  noncurrent_version_expiration_days = 90
  transition = [{
    days          = 30
    storage_class = "STANDARD_IA"
  }]
}]
```

### CORS Rule Configuration

```hcl
cors_rules = [{
  allowed_headers = ["*"]
  allowed_methods = ["GET", "PUT", "POST"]
  allowed_origins = ["https://example.com"]
  expose_headers  = ["ETag"]
  max_age_seconds = 3600
}]
```

## Outputs

| Name                          | Description                 |
| ----------------------------- | --------------------------- |
| `bucket_id`                   | Bucket ID                   |
| `bucket_arn`                  | Bucket ARN                  |
| `bucket_name`                 | Bucket name                 |
| `bucket_domain_name`          | Bucket domain name          |
| `bucket_regional_domain_name` | Bucket regional domain name |

## Security Features

### Encryption

All data encrypted at rest:

```hcl
# Default: AES-256
encryption_type = "AES256"

# KMS encryption for compliance
encryption_type = "aws:kms"
kms_key_arn     = aws_kms_key.s3.arn
```

### SSL Enforcement

Bucket policy automatically denies non-SSL requests:

```json
{
  "Effect": "Deny",
  "Principal": "*",
  "Action": "s3:*",
  "Condition": {
    "Bool": {
      "aws:SecureTransport": "false"
    }
  }
}
```

### Public Access Blocking

By default, all public access is blocked:

- Block public ACLs
- Block public bucket policies
- Ignore public ACLs
- Restrict public buckets

## Storage Classes

| Storage Class        | Use Case                 | Retrieval        |
| -------------------- | ------------------------ | ---------------- |
| STANDARD             | Frequently accessed      | Immediate        |
| STANDARD_IA          | Infrequent access        | Immediate        |
| ONEZONE_IA           | Non-critical, infrequent | Immediate        |
| GLACIER              | Archive                  | Minutes to hours |
| GLACIER_DEEP_ARCHIVE | Long-term archive        | 12-48 hours      |

## Cost Optimization

### Lifecycle Policies

```hcl
lifecycle_rules = [{
  id = "optimize-storage"
  transition = [
    { days = 30,  storage_class = "STANDARD_IA" },
    { days = 90,  storage_class = "GLACIER" },
    { days = 365, storage_class = "GLACIER_DEEP_ARCHIVE" }
  ]
  noncurrent_version_expiration_days = 30
}]
```

### Intelligent Tiering

For unpredictable access patterns, consider S3 Intelligent-Tiering (configure outside this module).

## Compliance

### Object Lock

For regulatory compliance (WORM):

```hcl
object_lock_enabled = true
```

### Versioning

Required for:

- Cross-region replication
- Object lock
- Point-in-time recovery

## Cost Considerations

| Component     | Cost Factor           |
| ------------- | --------------------- |
| Storage       | Per GB/month by class |
| Requests      | Per 1,000 requests    |
| Data Transfer | Egress charges        |
| Replication   | Per GB replicated     |

**Tips:**

- Use lifecycle policies to move data to cheaper tiers
- Enable S3 analytics to optimize storage classes
- Use VPC endpoints to avoid data transfer charges
